<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Invoice</title>
  <style>
    body, html {
      margin: 0; padding: 0; height: 100%; width: 100%;
      font-family: Arial, sans-serif; font-size: 12px;
      background-image: url("https://firebasestorage.googleapis.com/v0/b/bevgo-client-management-rckxs5.firebasestorage.app/o/Bevgo%20Media%2FBevgo%20Watermark.png?alt=media&token=d8209c3c-1cee-4555-aad7-b21441de9721");
      background-repeat: repeat; background-size: 100% auto; background-position: center;
    }
    p { margin: 0; }
    h3 { margin: 0 0 0.5rem 0; font-size: 1rem; }

    .page { display:flex; flex-direction:column; justify-content:flex-start; height:100%; padding:20px; box-sizing:border-box; gap:1rem; background:transparent; }
    .footer { margin-top:20px; text-align:center; font-size:12px; color:#777; }

    .header { display:flex; flex-direction:row; flex-wrap:nowrap; justify-content:space-around; gap:1rem; width:100%; align-items:stretch; }
    .bevgo-details { display:flex; flex-direction:column; justify-content:flex-start; align-items:flex-start; border:1px solid black; padding:.5rem; width:100%; }
    .details-container { display:flex; flex-direction:row; justify-content:flex-start; align-items:flex-start; gap:2rem; }
    .details-address, .details-contact { display:flex; flex-direction:column; justify-content:flex-start; align-items:flex-start; flex:1; }
    .bevgo-logo { width:250px; height:auto; object-fit:contain; }

    .invoice-number-section { display:flex; flex-direction:column; justify-content:flex-start; align-items:flex-start; padding:.5rem; border:1px solid black; width:100%; }

    .customer-details { display:flex; flex-direction:column; justify-content:flex-start; align-items:flex-start; padding:.5rem; border:1px solid black; }

    /* Items */
    .item-list { display:flex; flex-direction:column; gap:5px; margin:10px 0; }
    .order-items, .return-items { display:flex; flex-direction:column; border:1px solid black; padding:.5rem .5rem 2rem .5rem; }
    .order-items { flex-grow:1; }
    .item { display:flex; justify-content:space-between; align-items:center; padding:8px; gap:.5rem; }
    .item-heading { font-weight:bold; border:1px solid black; margin-bottom:5px; font-size:12px; }
    .heading-quantity, .heading-unit-price, .heading-return-type { display:flex; align-items:center; justify-content:center; border-right:1px solid black; flex:1.5; text-align:center; height:100%; }
    .heading-total { display:flex; align-items:center; justify-content:center; flex:1.5; text-align:center; height:100%; }
    .heading-product-image { width:32px; }
    .heading-product-title { display:flex; align-items:center; border-right:1px solid black; flex:3; text-align:left; height:100%; }

    .order-product-title, .return-product-title { flex:3; text-align:left; height:100%; }
    .order-quantity, .order-unit-price, .order-total, .return-return-type, .return-quantity, .return-unit-price, .return-total {
      flex:1.5; text-align:center; height:100%;
    }
    .order-product-image img { width:32px; height:32px; }

    .totals-container { display:flex; flex-direction:row; justify-content:flex-start; align-items:flex-start; gap:1rem; align-items:stretch; }
    .bank-details { display:flex; flex-direction:column; justify-content:flex-start; align-items:flex-start; padding:.5rem; border:1px solid black; width:100%; }
    .totals { display:flex; flex-direction:column; justify-content:flex-start; align-items:flex-start; padding:.5rem; border:1px solid black; width:100%; gap:.2rem; }
    .final-total { width:100%; border-top:1px solid black; }
    .breakdown-row { display:flex; flex-direction:row; justify-content:space-between; width:100%; }

    /* Loyalty visuals */
    .loyalty-banner {
      border:1px solid #2f855a; background:#f0fff4; color:#22543d;
      padding:8px 10px; border-radius:4px; font-weight:600; margin:.25rem 0;
    }
    .badge-loyalty {
      display:inline-block; margin-left:.5rem; padding:2px 6px;
      border:1px solid #2b6cb0; color:#2b6cb0; border-radius:3px; font-size:10px; font-weight:700; white-space:nowrap;
    }
  </style>
</head>
<body>
  <div class="page">
    <!-- Header -->
    <div class="header">
      <div class="bevgo-details">
        <img class="bevgo-logo" src="https://firebasestorage.googleapis.com/v0/b/bevgo-client-management-rckxs5.firebasestorage.app/o/Bevgo%20Media%2FBevgo%20Header%20Banner.png?alt=media&token=fb6ef880-b618-46c5-a1c3-e9bc1dd3690e" alt="Company Logo">
        <div class="details-container">
          <div class="details-address">
            <p><%= companyAddress %></p>
          </div>
          <div class="details-contact">
            <p><%= companyContact %></p>
            <p><%= companyEmail %></p>
            <p>VAT No: <%= companyVAT %></p>
          </div>
        </div>
      </div>
      <div class="invoice-number-section">
        <h3>Tax Invoice:</h3>
        <p>Invoice Number: <%= invoiceNumber %></p>
        <p>Invoiced Date: <%= invoiceDate %></p>
        <p>Payment Method: <%= paymentMethod %></p>
        <p>Payment Due: <%= dueDate %></p>
      </div>
    </div>

    <!-- Customer Details -->
    <div class="customer-details">
      <h3>Deliver To:</h3>
      <p><%= customer.name %></p>
      <p><%= customer.address %></p>
      <p><%= customer.contact %></p>
      <p><%= customer.email %></p>
      <p>VAT No: <%= customer.vat %></p>
    </div>

    <!-- Loyalty banner (if any free items) -->
    <% const hasFreeItems = Array.isArray(orderDetails?.cartDetails) && orderDetails.cartDetails.some(i => i && i.freeItem === true); %>
    <% if (hasFreeItems) { %>
      <div class="loyalty-banner">üéÅ This invoice includes a loyalty reward item at no charge.</div>
    <% } %>

    <!-- Delivered Items -->
    <div class="order-items">
      <h3>Delivered Items</h3>
      <div class="item item-heading">
        <div class="heading-product-image"></div>
        <div class="heading-product-title">Product</div>
        <div class="heading-quantity">QTY</div>
        <div class="heading-unit-price">Unit Price (VAT Excl.)</div>
        <div class="heading-total">Total</div>
      </div>
      <div class="order-item-list">
        <% (orderDetails.cartDetails || []).forEach(item => { %>
          <div class="item">
            <div class="order-product-image">
              <img src="<%= item.product_image %>"/>
            </div>
            <div class="order-product-title">
              <%= item.product_title %>
              <% if (item.freeItem === true) { %>
                <span class="badge-loyalty">LOYALTY REWARD</span>
              <% } %>
            </div>
            <div class="order-quantity"><%= item.quantity %></div>

            <div class="order-unit-price">
              <% if (item.freeItem === true) { %>
                R0.00
              <% } else { %>
                R<%= (item.on_sale && item.sale_price ? item.sale_price : item.price_excl).toFixed(2) %>
              <% } %>
            </div>

            <div class="order-total">
              <% if (item.freeItem === true) { %>
                R0.00
              <% } else { %>
                R<%= item.total_price.toFixed(2) %>
              <% } %>
            </div>
          </div>
        <% }) %>
      </div>
    </div>

    <!-- Returnables -->
    <% if (returns && returns.length > 0) { %>
      <div class="return-items">
        <h3>Returnables Collected</h3>
        <div class="item item-heading">
          <div class="heading-product-title">Product</div>
          <div class="heading-return-type">Return Type</div>
          <div class="heading-quantity">QTY</div>
          <div class="heading-unit-price">Unit Price (VAT Excl.)</div>
          <div class="heading-total">Total</div>
        </div>
        <div class="return-item-list">
          <% returns.forEach(returnable => { %>
            <div class="item">
              <div class="return-product-title"><%= returnable.returnable_item %> <%= returnable.volume || '' %><%= returnable.volume_unit || '' %></div>
              <div class="return-return-type"><%= returnable.is_full ? 'Full' : 'Partial' %></div>
              <div class="return-quantity"><%= returnable.quantity %></div>
              <div class="return-unit-price">R<%= ((returnable.is_full ? returnable.price_excl : returnable.partial_price_excl) || 0).toFixed(2) %></div>
              <div class="return-total">R<%= ((((returnable.is_full ? returnable.price_excl : returnable.partial_price_excl) || 0) * returnable.quantity).toFixed(2)) %></div>
            </div>
          <% }) %>
        </div>
      </div>
    <% } %>

    <!-- Totals -->
    <div class="totals-container">
      <div class="bank-details">
        <h3>Bank Details:</h3>
        <p>Account holder: BEVGO (PTY) Ltd</p>
        <p>Bank: Nedbank</p>
        <p>Account number: 1318880823</p>
        <p>Account type: Current account</p>
        <p>Branch code: 198765</p>
      </div>
      <div class="totals">
        <h3>Breakdown:</h3>
        <div class="breakdown-row">
          <p>Subtotal (VAT Excl.):</p>
          <p>R<%= finalTotals.subtotalBeforeVAT %></p>
        </div>
        <div class="breakdown-row">
          <p>Loyalty Discount (<%= finalTotals.rebatePercentage %>%):</p>
          <p>-R<%= finalTotals.rebateAmount %></p>
        </div>

        <!-- Loyalty items count (informational) -->
        <% const freeItemCount = (orderDetails.cartDetails || []).filter(i => i && i.freeItem === true).length; %>
        <% if (freeItemCount > 0) { %>
          <div class="breakdown-row">
            <p>Loyalty Reward Items:</p>
            <p><%= freeItemCount %> item<%= freeItemCount > 1 ? 's' : '' %> at R0.00</p>
          </div>
        <% } %>

        <!-- Applied Credit (new) -->
        <div class="breakdown-row">
          <p>Applied Credit:</p>
          <p>-R<%= Number(finalTotals.appliedCredit || 0).toFixed(2) %></p>
        </div>

        <div class="breakdown-row">
          <p>Returnable Deposit (VAT Excl.):</p>
          <p>+R<%= finalTotals.returnablesAdded %></p>
        </div>
        <div class="breakdown-row">
          <p>VAT (15%):</p>
          <p>R<%= finalTotals.recalculatedVAT %></p>
        </div>
        <div class="breakdown-row">
          <p>YOCO Fee (2.95%) + R0.50:</p>
          <p>+R<%= finalTotals.yocoFee %></p>
        </div>
        <div class="breakdown-row">
          <p>Returns Collected (VAT Incl.):</p>
          <p>-R<%= finalTotals.returnablesDeducted %></p>
        </div>

        <div class="final-total"></div>
        <div class="breakdown-row">
          <p><strong>Total:</strong></p>
          <p>R<%= finalTotals.finalTotal %></p>
        </div>
      </div>
    </div>
  </div>
</body>
</html>
